<!doctype html>
<html>
<head>
<title>Bismuth</title>
<style>
body {
    text-align: center;
    font-family: Arial;
}
h1, h2, h3, h4, p, div, ul {
    text-align: justify;
}
#sourcecode {
    font-family: Consolas, "Courier New", monospace;
    width: 100%;
    margin-top: 40px;
    min-height: 300px;
}
#generatedC, #generatedJS {
    white-space: pre;
    font-family: Consolas, "Courier New", monospace
}
#errors {
    font-family: Arial;
    color: #A00;
}
</style>
</head>
<body>
    <script src="define.js"></script>
    <script src="build/build.js"></script>
    <h1>Bismuth - Run Online</h1>
    <p>Bismuth is a pure, strongly and statically-typed <em>imperative</em> programming language that keeps code predictable and easy to refactor.</p>
    <p>Bismuth currently supports generic functions and data types, whose generic types can be constrained by user-defined interface.</p>
    <p>
        Functions specify their side-effects through <em>effect signatures</em>.
        These signatures explicitly denote the side-effects that a function can perform.
    </p>
    <p>
        Bismuth will soon support a linear type system which makes it very difficult to unintentionally leak resources.
    </p>
    <p>
        The Bismuth compiler is written in TypeScript.
        This page generates executable C; future versions will be able to generate JavaScript as well.
    </p>
    <textarea id="sourcecode">

struct Pair {
    var x: Int;
    var y: Int;
}

func getX(p: &amp;Pair) -> Int {
    return p.x;
}

func main!IO {
    var p: Pair = #Pair{x => 1, y => 2};
    var q: Int = getX(&amp;p);

    foreign#
        printf("q is %d\n", @[q]);
    #;
}
</textarea>

<script>



document.getElementById("sourcecode").addEventListener("keydown", (e) => {
    // https://stackoverflow.com/questions/6637341/use-tab-to-indent-in-textarea
    if (e.keyCode == 9) {
        e.preventDefault();
        var start = e.target.selectionStart;
        var end = e.target.selectionEnd;
        // set textarea value to: text before caret + tab + text after caret
        e.target.value = e.target.value.substr(0, start) + "\t" + e.target.value.substr(end);
        // put caret at right position again
        e.target.selectionStart = e.target.selectionEnd = start + 1;
        return;
    }
    if (e.keyCode == 13) {
        // add newline with tabs
        e.preventDefault();
        var start = e.target.selectionStart;
        var end = e.target.selectionEnd;

        let insert = "";
        for (let i = start-1; i >= 0; i--) {
            const c = e.target.value.charAt(i);
            if (c == "\t") {
                insert = c + insert;
            } else if (c == "\n") {
                break;
            } else {
                insert = "";
            }
        }
        insert = "\n" + insert;
        if (e.target.value.charAt(start-1) == "{") {
            insert += "\t";
        }
        // set textarea value to: text before caret + tab + text after caret
        e.target.value = e.target.value.substr(0, start) + insert + e.target.value.substr(end);
        // put caret at right position again
        e.target.selectionStart = e.target.selectionEnd = start + insert.length;
        return;
    }
    if (e.key == "}") {
        // de-indent by one tab before inserting
        var start = e.target.selectionStart;
        var end = e.target.selectionEnd;

        if (e.target.value.charAt(start-1) == "\t") {
            e.preventDefault();
            e.target.value = e.target.value.substr(0, start-1) + "}" + e.target.value.substr(end);
            e.target.selectionStart = e.target.selectionEnd = start;
        }
        return;
    }
});
</script>
    <script>
        let compile = obtain("compile").compile;
        let last = "";
        let compiled = false;
        setInterval(function() {
            let current = document.getElementById('sourcecode').value;
            if (current == last) {
                if (!compiled) {
                    compile(current);
                    compiled = true;
                }
            } else {
                compiled = false;
                last = current;
            }
        }, 500);
    </script>
    <div id="errors"></div>
    <div id="generatedJS" style="display:none"></div>
    <hr/>
    <div id="generatedC"></div>
</body>
</html>